FROM caddy:2-alpine

# Docker provides these build args automatically
ARG TARGETOS
ARG TARGETARCH

# Debug output
RUN echo "Building for ${TARGETOS}/${TARGETARCH}"

# Copy the pre-built binary for the target platform
# Expects binaries named: caddy-${TARGETOS}-${TARGETARCH}
COPY caddy-${TARGETOS}-${TARGETARCH} /usr/bin/caddy

# Ensure binary is executable
RUN chmod +x /usr/bin/caddy

# Copy GeoIP database if available
COPY geoip/* /usr/share/caddy/geoip/

# Clean up if only placeholder was copied
RUN if [ -f /usr/share/caddy/geoip/.placeholder ]; then \
      rm -rf /usr/share/caddy/geoip; \
    fi
